## 设计
用户买单的方式可能是一次性购买产品的使用权、购买产品会员享受高级功能等等。

1. 用户类别设计
2. 数据存储设计：因为会员和加油包有过期时间，如果把相关数据记录在像 MySQL 或者 Postgres 里，我还需要定时去更改用户角色，无形中给自己增加了开发量。为了让开发流程更丝滑，我选择了 Redis 作为数据存储的解决方案，我只需要给 Redis key 设置过期时间，key 过期就查不到了，等同于会员或加油包到期。
3. 服务端设计与开发：
4. 风险应对策略：涉及到金钱的功能一定要做好风险应对策略，否则出了生产事故就会对品牌产生很大影响。本文核心逻辑都是在操作 redis，所以主要考虑 redis 的连接和操作失败的问题。监控：使用 Upstash 提供的监控工具或其他第三方服务，如 Datadog 或 Sentry 来实时监控 Redis 的性能和错误率。这样，如果出现问题，你可以迅速得知并采取行动。

## 实现
首先，我们要选择支付平台和工具。如果你的产品立足国内，那么用支付宝和微信支付就足够，如果你的产品还想放眼海外，我推荐使用 Lemon Squeezy，原因有两个：
Lemon Squeezy 会根据用户所在地区提供不同的付费通道，其中包括微信、支付宝、信用卡和 Paypal 等全球常见的支付方式。
Lemon Squeezy 不仅仅是一个支付接入平台，它更像一个完整的解决方案，例如：它可以帮你管理订阅的自动续费，而微信支付、支付宝这样的渠道只有收付款功能，收付款以外的逻辑需要你自己设计开发。
### 设置产品
在 Lemon Squeezy 的后台，先创建一个产品，在创建产品的侧栏里，要添加两个 vaiant，可以理解为同一个产品的不同型号，跟你网购时一样，添加不同型号可以方便用户在一个产品链接里切换自己想付费购买的服务。

添加环境变量
安装依赖
lib/lemonsqueezy/lemons. ts 初始化 lemonsqueezy

### 获取购买链接
通过 lemonsqueezy 提供的 url api 获取购买链接

### 事件推送
事件推送 Webhooks。接收第三方平台推送的数据。

到 Lemon Squeezy 里设置 Webhooks，设置接收事件推送的接口。


[带你设计一套会员功能并开发它 | J 实验室](https://weijunext.com/article/ad3f4bff-0b78-4c04-bf12-98bffdc14611)
[基于Lemon Squeezy开发你的全球可用的会员功能 | J 实验室](https://weijunext.com/article/integrate-lemonsqueezy-api)